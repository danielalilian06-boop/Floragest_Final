<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Cliente - FloraGest</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body { font-family: Arial, sans-serif; }
    #contenido { display: flex; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
    table { max-width: 400px; margin: 10px; border-collapse: separate; border-spacing: 0; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background-color: white; }
    thead th { background-color: var(--color-primary); color: white; padding: 12px; text-align: center; }
    tbody tr:nth-child(even) { background-color: var(--color-accent); }
    tbody tr:hover { background-color: #f5f5f5; }
    td { padding: 12px; text-align: center; }
    button.agregar { background-color: var(--color-success); border: none; padding: 6px 12px; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; }
    .recomendado { background-color: #fff3b0 !important; font-weight: bold; }
    #menuUsuario { position: fixed; top: 0; left: 0; width: 100%; background-color: var(--color-primary); color: white; padding: 10px 20px; z-index: 5; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #buscadorDiv { max-width: 850px; margin: 100px auto 20px auto; text-align: center; }
    #buscadorDiv input, #buscadorDiv select { padding: 10px 12px; font-size: 1em; border-radius: 8px; border: 1px solid #ddd; margin-right: 10px; }
    h2 { text-align: center; color: var(--color-primary); }
    #recomendaciones { max-width: 400px; margin: 10px; padding: 20px; background-color: #f9f9f9; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    #chatIA { margin-top:25px; padding:15px; background-color:#eef7f2; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); width:90%; max-width:900px; margin-left:auto; margin-right:auto; }
    #respuestaIA { margin-top:15px; background:white; padding:10px; border-radius:8px; min-height:40px; }
    .alternativa { margin:8px 0; padding:8px; background:#fcfcfc; border-radius:6px; border-left:4px solid #e0e0e0; }
  </style>
</head>
<body>
  <div id="menuUsuario">
    <span>ðŸŒ¸ Cliente: {{ usuario }}</span>
    <div>
      <a href="/carrito"><button>ðŸ›’ Carrito</button></a>
      <a href="/soporte"><button>ðŸ’¬ Soporte</button></a>
      <a href="/logout"><button>Cerrar sesiÃ³n</button></a>
    </div>
  </div>

  <div id="buscadorDiv">
    <input type="text" id="buscador" placeholder="ðŸ” Busca tus flores aquÃ­...">
    <select id="temporadaSelect">
      <option value="">Todas las temporadas</option>
      <option value="Primavera">Primavera</option>
      <option value="Verano">Verano</option>
      <option value="OtoÃ±o">OtoÃ±o</option>
      <option value="Invierno">Invierno</option>
    </select>
  </div>

  <h2>Flores disponibles esta temporada</h2>

  <div id="contenido">
    <table>
      <thead>
        <tr>
          <th>Flor</th>
          <th>Precio</th>
          <th>Agregar</th>
        </tr>
      </thead>
      <tbody id="tablaFlores">
        {% for flor in flores %}
        <tr data-estacion="{{ flor.estacion }}">
          <td>{{ flor.nombre }}</td>
          <td>${{ flor.precio }}</td>
          <td><button class="agregar" onclick="agregarCarrito('{{ flor.nombre }}', '{{ flor.precio }}')">ðŸ›’</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div id="recomendaciones">
      <h3>Flores recomendadas</h3>
      <div id="listaRecomendadas">
        {% for estacion, flores_estacion in recomendaciones.items() %}
          <p><strong>{{ estacion }}:</strong> {{ flores_estacion|join(", ") }}</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <div id="chatIA">
    <h4>ðŸ¤– Asistente Floral Inteligente</h4>
    <p style="font-size:0.9em;">PregÃºntame por quÃ© se recomiendan ciertas flores o quÃ© flores son ideales para cada temporada:</p>
    <input id="preguntaIA" type="text" placeholder="Ejemplo: Â¿Por quÃ© los girasoles son de verano?" style="width:90%;padding:8px;border-radius:6px;border:1px solid #ccc;">
    <button id="btnPreguntar" style="padding:8px 10px;margin-top:8px;border:none;border-radius:6px;background-color:#4CAF50;color:white;font-weight:bold;cursor:pointer;">Preguntar</button>

    <div id="respuestaIA" style="margin-top:12px;">
      <!-- AquÃ­ aparecerÃ¡ la respuesta principal -->
    </div>

    <div id="alternativasIA" style="margin-top:10px;">
      <!-- AquÃ­ aparecerÃ¡n las alternativas -->
    </div>
  </div>

<script>
let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
const filasOriginales = Array.from(document.querySelectorAll("#tablaFlores tr"));

function agregarCarrito(nombre, precio) {
  carrito.push({ nombre, precio });
  localStorage.setItem("carrito", JSON.stringify(carrito));
  alert(nombre + " fue agregada al carrito ðŸŒ¸");
}

function filtrarFlores() {
  const filtro = document.getElementById("buscador").value.toLowerCase();
  const temporada = document.getElementById("temporadaSelect").value;
  const tbody = document.getElementById("tablaFlores");
  const listaRecomendadas = document.getElementById("listaRecomendadas");
  let floresRecomendadas = [];

  if (temporada) {
    const p = Array.from(listaRecomendadas.querySelectorAll("p"))
                   .find(p => p.querySelector("strong").textContent === temporada + ":");
    if (p) {
      floresRecomendadas = p.textContent.replace(temporada + ":","")
                                       .split(",")
                                       .map(f => f.trim().toLowerCase());
    }
  }

  tbody.innerHTML = "";

  let visibles = filasOriginales.filter(f => {
    const nombre = f.cells[0].textContent.toLowerCase();
    const estacion = f.getAttribute("data-estacion");
    const coincideNombre = nombre.includes(filtro);
    const coincideTemporada = !temporada || estacion === temporada;

    if (floresRecomendadas.includes(nombre)) f.classList.add("recomendado");
    else f.classList.remove("recomendado");

    return coincideNombre && coincideTemporada;
  });

  visibles.sort((a, b) => {
    const aRec = a.classList.contains("recomendado") ? -1 : 1;
    const bRec = b.classList.contains("recomendado") ? -1 : 1;
    return aRec - bRec;
  });

  visibles.forEach(f => tbody.appendChild(f));

  const recomendaciones = document.querySelectorAll("#listaRecomendadas p");
  recomendaciones.forEach(p => {
    if (!temporada || p.querySelector("strong").textContent === temporada + ":") p.style.display = "";
    else p.style.display = "none";
  });
}

document.getElementById("temporadaSelect").addEventListener("change", filtrarFlores);
document.getElementById("buscador").addEventListener("input", filtrarFlores);
window.addEventListener("load", filtrarFlores);

// IA: enviar pregunta y mostrar respuesta + alternativas
async function preguntarIA() {
  const pregunta = document.getElementById("preguntaIA").value.trim();
  const respuestaDiv = document.getElementById("respuestaIA");
  const altDiv = document.getElementById("alternativasIA");

  respuestaDiv.innerHTML = "";
  altDiv.innerHTML = "";

  if (!pregunta) {
    respuestaDiv.innerHTML = "ðŸ’¬ Por favor, escribe tu pregunta primero.";
    return;
  }

  respuestaDiv.innerHTML = "â³ Pensando...";
  try {
    const res = await fetch("/api/ia_flores", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pregunta })
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({}));
      throw new Error(err.respuesta || "Error en servidor");
    }
    const data = await res.json();
    // respuesta principal
    respuestaDiv.innerHTML = `<strong>IA Floral:</strong> ${data.respuesta}`;

    // alternativas (si hay)
    if (Array.isArray(data.alternativas) && data.alternativas.length > 0) {
      altDiv.innerHTML = "<h4>Otras explicaciones:</h4>";
      data.alternativas.forEach((a, i) => {
        // evitar repetir la principal dos veces
        if (a === data.respuesta && i === 0) return;
        const node = document.createElement("div");
        node.className = "alternativa";
        node.textContent = a;
        altDiv.appendChild(node);
      });
    }
  } catch (err) {
    console.error(err);
    respuestaDiv.innerHTML = "âš ï¸ Error al conectar con la IA simulada. Revisa la consola del servidor.";
  }
}

document.getElementById("btnPreguntar").addEventListener("click", preguntarIA);
document.getElementById("preguntaIA").addEventListener("keyup", (e) => {
  if (e.key === "Enter") preguntarIA();
});
</script>

</body>
</html>
